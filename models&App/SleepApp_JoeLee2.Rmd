---
title: "NHANES: What affects our sleep?"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows 
    vertical_layout: fill
    theme: "sandstone" 
runtime: shiny
---

```{r global, include=FALSE}

    library(rio)
    library(here)
    library(dplyr)
    library(tidyverse)
    library(flexdashboard)
    library(shiny)
    library(shinydashboard)
    library(plotly)
    library(summarytools)
    library(prettycode)
    library(titanic)
    library(lmerTest)
    library(ggridges)
    library(DT)
    library(ggeffects)
    library(splines)
    library(ggiraphExtra)
    library(ggplot2)
    library(ResourceSelection)
    library(pscl)
    library(DALEX)
    library(DALEXtra)
    library(tidymodels)

# import data
dat <- load(file = "ready.rda")
final_dat <- ready
```

# Exploratory Data Analysis

Inputs {.sidebar}
-----------------------------------------------------------------------

On average, humans spend about a 1/3 of each day sleeping. Good sleep is not only vital to our day-to-day functioning but also allows us to lead healthy lives. In the US, 50-70 million people suffer from insomnia. This dashboard uses the 2018 NHANES data to explore the different variables that can affect our sleep. 

Top 10 variables that affect sleep were identified using machine learning. Here, users can explore the data and run different machine learning models to learn about these variables in depth.

Change the X and Y to explore the relationships between various variables. "Color" segmented the chart further by the selected group but will not work when 2 non-numeric variables are chosen.


```{r}
# separate factors and numeric variables
var_factor <- final_dat %>% 
  select_if(is.factor)
var_factor <- colnames(var_factor)
var_numeric <- final_dat %>% 
  select_if(is.numeric)
var_numeric <- colnames(var_numeric[-1])
# shiny app input numeric
selectInput("x", label = "X", names(final_dat))
selectInput("y", label = "Y", c("none", names(final_dat)), names(final_dat)[[2]])
selectInput("color", "Color by group", c("none", var_factor))
```


App authors: Briha Ansari, MD., Feng-Chiao Lee, Tim Lee, MD.

Row
-----------------------------------------------------------------------
### Total N
```{r}
total <- nrow(final_dat)
valueBox(total, "Total", icon = icon("users"), color = "olive")
```

### Average sleep hours
```{r}
hours <- 7.6
valueBox(hours, "Average Sleep Hours", icon = icon("bed"),color = "olive")
```

### % Trouble sleeping
```{r}
valueBox(scales::percent(.285),"Percent", icon = icon("exclamation-circle"),color = "olive")
```

Row
-----------------------------------------------------------------------


# Logistic Regression
Inputs {.sidebar}
-----------------------------------------------------------------------
Answer the following questions to find out your likelihood of having sleep problems:

```{r}
# age
selectInput("age.cat2", label = "age.cat2: Your Age Range", 
    choices = list("19-35" = "19-35", "36-50" = "36-50","51-65"="51-65","above65"="above65"), 
    selected = "19-35")
# bmi
numericInput("bmi", label = "bmi: Body Mass Index (kg/m^2)", value = 20,  min = 12, max = 90, step = 0.1)  
```

*Mental Health*
```{r}
# mental health
# depression
selectInput("depression", label = "depression: How often do you feel depressed?", 
    choices = list("daily" = "Daily", "weekly" = "weekly", "monthly" = "monthly",'few_times_year'='few_times_year','never'='never'), 
    selected = "never")
# anxiety
selectInput("anxious", label = "anxious:  How often do you feel worried or anxious?", 
    choices = list("daily" = "daily", "monthly" = "monthly","few/yr"="few/yr","never"="never"), 
    selected = "never")
```

*Physical Health*
```{r}
# physical strength
selectInput("difficult_move_objects", label = "difficult_move_objects: Difficulty moving large objects?", 
    choices = list("no" = "no", "some" = "some", "much" = "much",'unable'='unable','dont_do_this_activity'='dont_do_this_activity'), 
    selected = "no")
# snorting
selectInput("snort", label = "snort:  How often do you snort or stop breathing?", 
    choices = list("never" = "never", "1-2/wk" = "1-2/wk","3-4/wk"="3-4/wk","5/wk"="5/wk"), 
    selected = "never")
```

*Lab values*
```{r}
# lab values
# crp
sliderInput("crp", label = "crp: HS C-Reactive Protein (mg/L)?",
            min = 0, 
            max = round(max(final_dat$crp),2), 
            value =round(0,2),step =0.01)
# iron
sliderInput("iron_um_l", label = "iron_um_l - Iron frozen, Serum (umol/L)",
            min =0, 
            max = round(max(final_dat$iron_um_l),2), 
            value =round(20,2),step =0.5)
```

*Plot*
```{r}
selectInput("variable", label = "Choose a Variable to see how it affects sleep problems", names(final_dat))
```


```{r reactive expression}

logitMod <- glm(formula = sleep_problems ~ depression  
                + bmi 
                + difficult_move_objects 
                + snort+crp+anxious
                + iron_um_l
                + age.cat2,data = final_dat,family = binomial(link = "logit"))
```

Row {data-height=450} 
-----------------------------------------------------------------------
### Variable Effect on Sleeping Problem
```{r histogram}
renderPlot({
  
ggpredict(logitMod, terms = input$variable ,fill=input$variable)%>%plot()
  })
```

### Vip
```{r}
renderPlot({
  library(vip)
  vip(logitMod ,mapping = aes_string(fill = "Variable"))
  
})

```

Row {data-height=350}
--------------
### Model Proformance
```{r}

library(pROC)
test_prob = predict(logitMod, newdata = final_dat, type = "response")
test_roc = roc(final_dat$sleep_problems ~ test_prob, plot = TRUE, print.auc = TRUE)





```





### Sleeping Problem
```{r}
renderValueBox({
  testdata <- data.frame(depression =input$depression,
                       snort=input$snort,
                       difficult_move_objects = input$difficult_move_objects,
                       snort = input$snort,
                       crp = input$crp,
                       iron_um_l = input$iron_um_l,
                       anxious = input$anxious,
                       bmi=input$bmi,
                       age.cat2 = input$age.cat2)
testdata$prob<- predict(logitMod, newdata=testdata, type="response")
valueBox(value = scales::percent(round(testdata$prob,2)), 
         subtitle = "Sleeping Problem %",
         icon = icon("exclamation-circle"),
         width = 4,
         color = "lime")
})
```



# Regularized Logistic Regression
Inputs {.sidebar}
-----------------------------------------------------------------------

```{r load model & data}
final_mdl_wf <- readRDS("final_lr_wf.RDS") 
```


```{r xplainable, include=FALSE}
final_mdl_wf_trained <- final_mdl_wf %>% 
  fit(data = ready)
mdl_explainer <- explain_tidymodels(
                        model = final_mdl_wf_trained, 
                        data = ready %>% 
                          select(-sleep_problems), 
                        y = ready$sleep_problems,
                        label = "chosen model")
```

Answer the following questions to find out your likelihood of having sleep problems:

```{r}
# age
selectInput("age.cat2", label = "age.cat2: Your Age Range", 
    choices = list("19-35" = "19-35", "36-50" = "36-50","51-65"="51-65","above65"="above65"), 
    selected = "19-35")
# bmi
numericInput("bmi", label = "bmi: Body Mass Index (kg/m^2)", value = 20,  min = 12, max = 90, step = 0.1)  
```

**Mental Health**
```{r}
# mental health
# depression
selectInput("depression", label = "depression: How often do you feel depressed?", 
    choices = list("daily" = "Daily", "weekly" = "weekly", "monthly" = "monthly",'few_times_year'='few_times_year','never'='never'), 
    selected = "never")
# anxiety
selectInput("anxious", label = "anxious:  How often do you feel worried or anxious?", 
    choices = list("daily" = "daily", "monthly" = "monthly","few/yr"="few/yr","never"="never"), 
    selected = "never")
```

**Physical Health**
```{r}
# physical strength
selectInput("difficult_move_objects", label = "difficult_move_objects: Difficulty moving large objects?", 
    choices = list("no" = "no", "some" = "some", "much" = "much",'unable'='unable','dont_do_this_activity'='dont_do_this_activity'), 
    selected = "no")
# snorting
selectInput("snort", label = "snort:  How often do you snort or stop breathing?", 
    choices = list("never" = "never", "1-2/wk" = "1-2/wk","3-4/wk"="3-4/wk","5/wk"="5/wk"), 
    selected = "never")
```

**Lab values**
```{r}
# lab values
# crp
sliderInput("crp", label = "crp: HS C-Reactive Protein (mg/L)?",
            min = 0, 
            max = round(max(final_dat$crp),2), 
            value =round(0,2),step =0.01)
# iron
sliderInput("iron_um_l", label = "iron_um_l - Iron frozen, Serum (umol/L)",
            min =0, 
            max = round(max(final_dat$iron_um_l),2), 
            value =round(20,2),step =0.5)
```

```{r}
new_obs <- reactive({tibble(depression = input$depression,
                           bmi = input$bmi,
                           difficult_move_objects = input$difficult_move_objects,
                           snort = input$snort,
                           crp = input$crp,
                           anxious = input$anxious,
                           iron_um_l = input$iron_um_l,
                           age.cat2 = input$age.cat2)})
prob <- reactive({predict(mdl_explainer, newdata = new_obs())})
```

Column {data-width=500} {.tabset}
-----------------------------------------------------------------------
in this section model explanations at __global level__ are displayed

### variable importance plot

```{r}
  vimp <- model_parts(mdl_explainer)
  plot(vimp)
```



### partial dependency plot

```{r}
  mprofile_group <- model_profile(explainer = mdl_explainer, 
                                  variables = c("bmi", "crp"),
                                  groups = "age.cat2", 
                                  type = "partial")
  plot(mprofile_group)
```

Column {data-width=500} {.tabset}
-----------------------------------------------------------------------

in this section model explanations at __local level__ are displayed

### prediction {data-height=50}
```{r}
renderText(expr = { 
  paste0("probability of having sleep problems: ", 
         round(prob() * 100,2), "%")
})
```



### break down profile
```{r}
renderPlot({
  plot(predict_parts_break_down(explainer = mdl_explainer,
                                new_observation = new_obs()))
})
```


### ceteris paribus profile BMI

```{r}
cp <- reactive({ mdl_explainer %>% 
  predict_profile(new_observation = new_obs(),
                  variables = c("bmi", "crp", "iron_um_l"))
})
```

```{r}

```

### ceteris paribus profile CRP

```{r}
renderPlot(plot(cp(), variables = "crp"))
```

### ceteris paribus profile IRON

```{r}
renderPlot(plot(cp(), variables = "iron_um_l"))
```

# Support Vector Machine
Inputs {.sidebar}
-----------------------------------------------------------------------

```{r}
final_mdl_wf <- readRDS("final_svmr_wf.RDS")  
```

```{r, include=FALSE}
final_mdl_wf_trained <- final_mdl_wf %>% 
  fit(data = ready)
mdl_explainer <- explain_tidymodels(
                        model = final_mdl_wf_trained, 
                        data = ready %>% 
                          select(-sleep_problems), 
                        y = ready$sleep_problems,
                        label = "chosen model")
```

Answer the following questions to find out your likelihood of having sleep problems:

```{r}
# age
selectInput("age.cat2", label = "age.cat2: Your Age Range", 
    choices = list("19-35" = "19-35", "36-50" = "36-50","51-65"="51-65","above65"="above65"), 
    selected = "19-35")
# bmi
numericInput("bmi", label = "bmi: Body Mass Index (kg/m^2)", value = 20,  min = 12, max = 90, step = 0.1)  
```

**Mental Health**
```{r}
# mental health
# depression
selectInput("depression", label = "depression: How often do you feel depressed?", 
    choices = list("daily" = "Daily", "weekly" = "weekly", "monthly" = "monthly",'few_times_year'='few_times_year','never'='never'), 
    selected = "never")
# anxiety
selectInput("anxious", label = "anxious:  How often do you feel worried or anxious?", 
    choices = list("daily" = "daily", "monthly" = "monthly","few/yr"="few/yr","never"="never"), 
    selected = "never")
```

**Physical Health**
```{r}
# physical strength
selectInput("difficult_move_objects", label = "difficult_move_objects: Difficulty moving large objects?", 
    choices = list("no" = "no", "some" = "some", "much" = "much",'unable'='unable','dont_do_this_activity'='dont_do_this_activity'), 
    selected = "no")
# snorting
selectInput("snort", label = "snort:  How often do you snort or stop breathing?", 
    choices = list("never" = "never", "1-2/wk" = "1-2/wk","3-4/wk"="3-4/wk","5/wk"="5/wk"), 
    selected = "never")
```

**Lab values**
```{r}
# lab values
# crp
sliderInput("crp", label = "crp: HS C-Reactive Protein (mg/L)?",
            min = 0, 
            max = round(max(final_dat$crp),2), 
            value =round(0,2),step =0.01)
# iron
sliderInput("iron_um_l", label = "iron_um_l - Iron frozen, Serum (umol/L)",
            min =0, 
            max = round(max(final_dat$iron_um_l),2), 
            value =round(20,2),step =0.5)
```

Column {data-width=500} {.tabset}
-----------------------------------------------------------------------
in this section model explanations at __global level__ are displayed

### variable importance plot

```{r}
  vimp <- model_parts(mdl_explainer)
  plot(vimp)
```



### partial dependency plot

```{r}
  mprofile_group <- model_profile(explainer = mdl_explainer, 
                                  variables = c("bmi", "crp"),
                                  groups = "age.cat2", 
                                  type = "partial")
  plot(mprofile_group)
```

Column {data-width=500} {.tabset}
-----------------------------------------------------------------------

in this section model explanations at __local level__ are displayed

### prediction {data-height=50}
```{r}
renderText(expr = { 
  paste0("probability of having sleep problems: ", 
         round(prob() * 100,2), "%")
})
```



### break down profile
```{r}
renderPlot({
  plot(predict_parts_break_down(explainer = mdl_explainer,
                                new_observation = new_obs()))
})
```


### ceteris paribus profile BMI

```{r}
cp <- reactive({ mdl_explainer %>% 
  predict_profile(new_observation = new_obs(),
                  variables = c("bmi", "crp", "iron_um_l"))
})
```

```{r}
renderPlot(plot(cp(), variables = "bmi"))
```

### ceteris paribus profile CRP

```{r}
renderPlot(plot(cp(), variables = "crp"))
```

### ceteris paribus profile IRON

```{r}
renderPlot(plot(cp(), variables = "iron_um_l"))
```